<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WinWin - Mapping 360° Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        :root { --winwin-dark: #3176A6; --winwin-light: #8CB4D2; }
        .bg-winwin-dark { background-color: var(--winwin-dark); }
        .text-winwin-dark { color: var(--winwin-dark); }
        .border-winwin-dark { border-color: var(--winwin-dark); }
        .hover-bg-winwin-dark:hover { background-color: #255a80; } 
        .bg-winwin-light { background-color: var(--winwin-light); }
        .text-winwin-light { color: var(--winwin-light); }
        .border-winwin-light { border-color: var(--winwin-light); }
        .bg-stripes-red { background-color: #fef2f2; background-image: repeating-linear-gradient(45deg, #fee2e2, #fee2e2 10px, #fca5a5 10px, #fca5a5 20px); }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: var(--winwin-dark); cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px rgba(49, 118, 166, 0.5); border: 2px solid white; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #e2e8f0; border-radius: 5px; }
        .bar-transition { transition: height 1s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.5s; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 60; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #modal-overlay { opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #modal-overlay.open { opacity: 1; pointer-events: all; }
        #modal-content { transform: scale(0.95); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; }
        #modal-overlay.open #modal-content { transform: scale(1); opacity: 1; }
        .service-card:checked + div { border-color: var(--winwin-dark); background-color: #f0f9ff; box-shadow: 0 0 0 2px var(--winwin-dark); }
        .service-card:checked + div .check-icon { opacity: 1; transform: scale(1); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 py-12 px-4 selection:bg-[#8CB4D2] selection:text-white relative">

    <div id="toast" class="flex items-center gap-3"><i data-lucide="copy-check" class="text-green-400"></i><span>Demande copiée ! Collez-la dans votre message.</span></div>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden max-h-[95vh] overflow-y-auto">
            <div class="bg-winwin-dark p-5 text-white text-center">
                <div class="mx-auto bg-white/20 w-10 h-10 rounded-full flex items-center justify-center mb-3"><i data-lucide="file-check" class="w-5 h-5"></i></div>
                <h3 class="text-xl font-bold">Votre Planification</h3>
                <p class="text-winwin-light text-sm mt-1">Choisissez votre niveau d'accompagnement</p>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- SERVICE CHOICE -->
                <div>
                    <label class="block text-sm font-bold text-slate-600 mb-3 uppercase tracking-wide">Quel service souhaitez-vous ?</label>
                    <div class="space-y-3">
                        <label class="cursor-pointer relative block">
                            <input type="radio" name="serviceType" value="standard" class="service-card peer sr-only" checked onchange="toggleServiceDetails()">
                            <div class="p-4 rounded-xl border-2 border-slate-200 hover:border-slate-300 transition-all flex items-start gap-4">
                                <div class="bg-slate-100 p-2 rounded-lg text-slate-600"><i data-lucide="zap" class="w-5 h-5"></i></div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1"><span class="font-bold text-slate-800">Offre Ciblée (Standard)</span><span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">Gratuit</span></div>
                                    <p class="text-xs text-slate-500">Proposition d'assurance simple basée sur cette simulation.</p>
                                </div>
                                <div class="check-icon opacity-0 transform scale-50 transition-all absolute top-4 right-4 text-winwin-dark"><i data-lucide="check-circle-2" class="w-5 h-5 fill-current"></i></div>
                            </div>
                        </label>
                        <label class="cursor-pointer relative block">
                            <input type="radio" name="serviceType" value="expert" class="service-card peer sr-only" onchange="toggleServiceDetails()">
                            <div class="p-4 rounded-xl border-2 border-slate-200 hover:border-slate-300 transition-all flex items-start gap-4">
                                <div class="bg-yellow-50 p-2 rounded-lg text-yellow-600"><i data-lucide="search-check" class="w-5 h-5"></i></div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1"><span class="font-bold text-slate-800">Analyse Expert</span><span id="price-tag" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-bold">250.-</span></div>
                                    <p class="text-xs text-slate-500 mb-2">Calcul réel sur pièces (AVS, LPP), optimisation & conciergerie administrative.</p>
                                    
                                    <!-- Couple Toggle -->
                                    <div id="couple-toggle-area" class="hidden mt-3 bg-white p-2 rounded border border-yellow-200 flex items-center justify-between">
                                        <span class="text-xs font-bold text-slate-600">Formule :</span>
                                        <div class="flex bg-slate-100 rounded p-1">
                                            <button type="button" onclick="setCoupleMode(false)" id="btn-solo" class="px-3 py-1 text-xs rounded font-bold bg-white shadow text-slate-800 transition-all">Individuel (250.-)</button>
                                            <button type="button" onclick="setCoupleMode(true)" id="btn-couple" class="px-3 py-1 text-xs rounded font-bold text-slate-500 hover:text-slate-800 transition-all">Couple (350.-)</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="check-icon opacity-0 transform scale-50 transition-all absolute top-4 right-4 text-winwin-dark"><i data-lucide="check-circle-2" class="w-5 h-5 fill-current"></i></div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="border-t border-slate-100 pt-4">
                    
                    <!-- PERSONNE 1 -->
                    <div class="mb-6">
                        <h4 class="text-xs font-bold text-winwin-dark uppercase tracking-wider mb-4 flex items-center gap-2"><i data-lucide="user" class="w-4 h-4"></i> Votre Profil (P1)</h4>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Prénom</label><input type="text" id="input-fname" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:border-winwin-dark outline-none"></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Nom</label><input type="text" id="input-lname" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:border-winwin-dark outline-none"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Date de naissance</label><input type="date" id="input-dob" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:border-winwin-dark outline-none"></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Profession</label><input type="text" id="input-profession" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:border-winwin-dark outline-none"></div>
                        </div>
                        <div class="mb-4"><label class="block text-xs font-bold text-slate-500 mb-2">Fumeur ?</label><div class="flex gap-4"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="smoker" value="oui" class="accent-winwin-dark"><span class="text-sm">Oui</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="smoker" value="non" class="accent-winwin-dark" checked><span class="text-sm">Non</span></label></div></div>
                    </div>

                    <!-- PERSONNE 2 (COUPLE) -->
                    <div id="partner-section" class="hidden mb-6 pt-4 border-t border-dashed border-slate-300">
                        <h4 class="text-xs font-bold text-purple-600 uppercase tracking-wider mb-4 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> Conjoint / Partenaire (P2)</h4>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Prénom (P2)</label><input type="text" id="input-fname-p2" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:border-purple-500 outline-none"></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Nom (P2)</label><input type="text" id="input-lname-p2" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:border-purple-500 outline-none"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Date naissance</label><input type="date" id="input-dob-p2" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:border-purple-500 outline-none"></div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Statut</label>
                                <select id="input-status-p2" onchange="toggleEmployerFields()" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:border-purple-500 outline-none">
                                    <option value="Employé">Employé</option>
                                    <option value="Indépendant">Indépendant</option>
                                    <option value="Sans activité">Sans activité</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Profession</label><input type="text" id="input-profession-p2" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:border-purple-500 outline-none"></div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Fumeur ?</label>
                                <div class="flex gap-4 mt-2">
                                    <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="smoker-p2" value="oui" class="accent-purple-500"><span class="text-xs">Oui</span></label>
                                    <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="smoker-p2" value="non" class="accent-purple-500" checked><span class="text-xs">Non</span></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SITUATION COMMUNE -->
                    <div class="pt-4 border-t border-slate-100">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Situation Familiale</h4>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">État Civil</label><select id="input-civil" onchange="toggleMarriageDate()" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-800 focus:border-winwin-dark outline-none"><option value="Célibataire">Célibataire</option><option value="Marié(e)">Marié(e)</option><option value="Partenariat">Partenariat</option><option value="Divorcé(e)">Divorcé(e)</option><option value="Veuf/Veuve">Veuf / Veuve</option></select></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Nombre Enfants</label><input type="number" id="input-children-count" value="0" min="0" oninput="updateChildrenFields()" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-800 focus:border-winwin-dark focus:bg-white outline-none"></div>
                        </div>
                        <div id="div-marriage-date" class="hidden mb-4 p-3 bg-blue-50 rounded-lg border border-blue-100"><label class="block text-xs font-bold text-winwin-dark mb-1">Date de Mariage / Partenariat</label><input type="date" id="input-marriage-date" class="w-full bg-white border border-blue-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-800 focus:border-winwin-dark outline-none"><p class="text-[10px] text-slate-500 mt-1 italic">Règle des 5 ans.</p></div>
                        
                        <!-- Dynamic Children Fields -->
                        <div id="children-details-container" class="space-y-3 mb-4"></div>
                    </div>

                    <!-- EXPERT CHECKLIST & CONCIERGERIE -->
                    <div id="expert-checklist" class="hidden pt-4 border-t border-slate-100">
                        <div class="bg-blue-50 p-3 rounded-lg mb-3 border border-blue-100 shadow-sm">
                            <h5 class="text-xs font-bold text-winwin-dark uppercase mb-1 flex items-center gap-1"><i data-lucide="pen-tool" class="w-3 h-3"></i> Conciergerie Administrative</h5>
                            <label class="flex items-start gap-3 cursor-pointer">
                                <div class="relative flex items-center pt-1"><input type="checkbox" id="check-mandate" onchange="toggleEmployerFields()" class="accent-winwin-dark w-4 h-4"></div>
                                <span class="text-xs text-slate-700 leading-snug"><strong>Je vous donne mandat (Procuration)</strong><br>J'autorise WinWin à récupérer mes documents (AVS/LPP) auprès des caisses.</span>
                            </label>
                            
                            <!-- Champs Employeur P1 -->
                            <div id="employer-fields-p1" class="hidden mt-3 pt-3 border-t border-blue-200">
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Employeur (Vous)</label>
                                <input type="text" id="input-emp-p1-name" placeholder="Entreprise (P1)" class="w-full mb-2 bg-white border border-blue-200 rounded px-2 py-1 text-xs focus:border-winwin-dark outline-none">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="input-emp-p1-loc" placeholder="Localité" class="w-full bg-white border border-blue-200 rounded px-2 py-1 text-xs focus:border-winwin-dark outline-none">
                                    <input type="text" id="input-emp-p1-phone" placeholder="Tél" class="w-full bg-white border border-blue-200 rounded px-2 py-1 text-xs focus:border-winwin-dark outline-none">
                                </div>
                            </div>

                            <!-- Champs Employeur P2 -->
                            <div id="employer-fields-p2" class="hidden mt-3 pt-3 border-t border-blue-200">
                                <label class="block text-[10px] font-bold text-purple-600 uppercase mb-2">Employeur (Conjoint)</label>
                                <input type="text" id="input-emp-p2-name" placeholder="Entreprise (P2)" class="w-full mb-2 bg-white border border-blue-200 rounded px-2 py-1 text-xs focus:border-purple-500 outline-none">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="input-emp-p2-loc" placeholder="Localité" class="w-full bg-white border border-blue-200 rounded px-2 py-1 text-xs focus:border-purple-500 outline-none">
                                    <input type="text" id="input-emp-p2-phone" placeholder="Tél" class="w-full bg-white border border-blue-200 rounded px-2 py-1 text-xs focus:border-purple-500 outline-none">
                                </div>
                            </div>
                        </div>

                        <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">Documents à analyser</label>
                        <div class="space-y-2">
                            <label class="flex items-center gap-3 p-2 border border-slate-200 rounded bg-white cursor-pointer hover:bg-slate-50 transition-colors"><input type="checkbox" id="check-avs" class="accent-winwin-dark w-4 h-4"><span class="text-xs text-slate-600" id="label-avs">Compte Individuel AVS</span></label>
                            
                            <!-- Documents Vous -->
                            <div id="doc-employee" class="hidden space-y-2">
                                <label class="flex items-center gap-3 p-2 border border-slate-200 rounded bg-white cursor-pointer hover:bg-slate-50 transition-colors"><input type="checkbox" id="check-contract" class="accent-winwin-dark w-4 h-4"><div class="flex flex-col"><span class="text-xs text-slate-600 font-bold">Contrat travail (Vous)</span><span class="text-[10px] text-slate-400">Couverture 720j</span></div></label>
                                <label class="flex items-center gap-3 p-2 border border-slate-200 rounded bg-white cursor-pointer hover:bg-slate-50 transition-colors"><input type="checkbox" id="check-lpp" class="accent-winwin-dark w-4 h-4"><span class="text-xs text-slate-600">Certificat LPP (Vous)</span></label>
                            </div>
                            <div id="doc-independent" class="hidden space-y-2">
                                <label class="flex items-center gap-3 p-2 border border-slate-200 rounded bg-white cursor-pointer hover:bg-slate-50 transition-colors"><input type="checkbox" id="check-apg-maladie" class="accent-winwin-dark w-4 h-4"><span class="text-xs text-slate-600">APG Maladie (Vous)</span></label>
                                <label class="flex items-center gap-3 p-2 border border-slate-200 rounded bg-white cursor-pointer hover:bg-slate-50 transition-colors"><input type="checkbox" id="check-apg-accident" class="accent-winwin-dark w-4 h-4"><span class="text-xs text-slate-600">LAA/Accident (Vous)</span></label>
                            </div>

                            <!-- Documents Partenaire (Si couple) -->
                            <div id="doc-partner" class="hidden space-y-2 pt-2 border-t border-slate-100">
                                <div class="text-[10px] font-bold text-purple-600 uppercase mb-1">Pour votre Partenaire</div>
                                <label class="flex items-center gap-3 p-2 border border-slate-200 rounded bg-white cursor-pointer hover:bg-slate-50 transition-colors"><input type="checkbox" id="check-avs-p2" class="accent-purple-500 w-4 h-4"><span class="text-xs text-slate-600">Compte AVS (Partenaire)</span></label>
                                <label class="flex items-center gap-3 p-2 border border-slate-200 rounded bg-white cursor-pointer hover:bg-slate-50 transition-colors"><input type="checkbox" id="check-lpp-p2" class="accent-purple-500 w-4 h-4"><span class="text-xs text-slate-600">LPP ou APG (Partenaire)</span></label>
                            </div>

                            <label class="flex items-center gap-3 p-2 border border-slate-200 rounded bg-white cursor-pointer hover:bg-slate-50 transition-colors"><input type="checkbox" id="check-3pilier" class="accent-winwin-dark w-4 h-4"><span class="text-xs text-slate-600" id="label-3pilier">Polices 3e pilier existantes</span></label>
                        </div>
                    </div>
                </div>

                <div class="pt-2">
                    <button onclick="finalSubmit()" id="btn-submit-modal" class="w-full bg-yellow-400 hover:bg-yellow-300 text-slate-900 font-bold py-4 rounded-xl shadow-lg shadow-yellow-400/20 transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2"><span>Valider</span><i data-lucide="arrow-right" class="w-5 h-5"></i></button>
                    <button onclick="closeModal()" class="w-full mt-3 text-slate-400 text-sm font-medium hover:text-slate-600">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div class="max-w-4xl mx-auto text-center mb-10">
        <div class="flex justify-center mb-4"><div class="bg-winwin-dark text-white p-3 rounded-2xl shadow-lg shadow-[#3176A6]/30"><i data-lucide="calculator" class="w-8 h-8"></i></div></div>
        <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-slate-900">Votre <span class="text-transparent bg-clip-text bg-gradient-to-r from-[#3176A6] to-[#8CB4D2]">Mapping 360°</span></h1>
        <p class="text-lg text-slate-600">Analysez instantanément votre protection financière et projetez votre avenir.</p>
    </div>

    <div class="max-w-7xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200 flex flex-col lg:flex-row">
        <!-- LEFT PANEL -->
        <div class="lg:w-1/3 bg-slate-100 p-6 md:p-8 border-r border-slate-200 flex flex-col gap-6">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <label class="flex items-center gap-2 text-sm font-bold text-slate-500 uppercase tracking-wider mb-4"><i data-lucide="coins" class="w-4 h-4 text-winwin-dark"></i> Revenu Mensuel Brut</label>
                <div class="flex items-center gap-4 mb-4"><div class="relative flex-1"><input type="number" id="salaryInput" value="6500" class="w-full text-3xl font-bold text-slate-800 border-b-2 border-winwin-light focus:border-winwin-dark outline-none py-2 bg-transparent transition-colors"><span class="absolute right-0 top-3 text-slate-400 font-bold">CHF</span></div></div>
                <input type="range" id="salaryRange" min="3000" max="25000" step="100" value="6500">
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <label class="flex items-center gap-2 text-sm font-bold text-slate-500 uppercase tracking-wider mb-4"><i data-lucide="hourglass" class="w-4 h-4 text-winwin-dark"></i> Votre Âge Actuel</label>
                <div class="flex items-center gap-4 mb-4"><div class="relative flex-1"><input type="number" id="ageInput" value="40" class="w-full text-3xl font-bold text-slate-800 border-b-2 border-winwin-light focus:border-winwin-dark outline-none py-2 bg-transparent transition-colors"><span class="absolute right-0 top-3 text-slate-400 font-bold">Ans</span></div><div class="text-right"><div class="text-xs text-slate-400 font-bold uppercase">Horizon 65 ans</div><div class="text-winwin-dark font-bold text-lg"><span id="years-left">25</span> ans restants</div></div></div>
                <input type="range" id="ageRange" min="18" max="64" step="1" value="40">
                <div class="mt-4 h-2 bg-slate-100 rounded-full overflow-hidden flex"><div id="age-progress-past" class="h-full bg-slate-300" style="width: 61%"></div><div id="age-progress-future" class="h-full bg-winwin-dark" style="width: 39%"></div></div>
            </div>
            <div>
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Votre Statut</h3>
                <div class="flex flex-col gap-2">
                    <button onclick="setStatus('employee')" id="btn-employee" class="status-btn flex items-center justify-between p-4 rounded-xl transition-all border-2 border-winwin-dark bg-[#eef6fa] text-winwin-dark"><div class="flex items-center gap-3 font-bold"><i data-lucide="briefcase" class="w-5 h-5"></i> Employé</div><span class="text-xs bg-white text-winwin-dark border border-winwin-light px-2 py-1 rounded-full font-bold">Avec LPP</span></button>
                    <button onclick="setStatus('independent')" id="btn-independent" class="status-btn flex items-center justify-between p-4 rounded-xl transition-all border-2 border-transparent bg-white text-slate-600 hover:bg-white/50"><div class="flex items-center gap-3 font-bold"><i data-lucide="user" class="w-5 h-5"></i> Indépendant</div><span id="tag-indep" class="hidden text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-bold">Sans LPP</span></button>
                </div>
            </div>
            <div>
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Scénario de vie</h3>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="setScenario('invalidite')" id="btn-invalidite" class="scenario-btn p-3 rounded-lg text-left font-bold transition-all flex items-center gap-3 bg-slate-800 text-white shadow-lg"><i data-lucide="activity" class="w-5 h-5 text-orange-400"></i> Invalidité</button>
                    <button onclick="setScenario('deces')" id="btn-deces" class="scenario-btn p-3 rounded-lg text-left font-bold transition-all flex items-center gap-3 bg-white text-slate-600 hover:bg-white/80"><i data-lucide="heart-pulse" class="w-5 h-5"></i> Décès</button>
                    <button onclick="setScenario('retraite')" id="btn-retraite" class="scenario-btn p-3 rounded-lg text-left font-bold transition-all flex items-center gap-3 bg-white text-slate-600 hover:bg-white/80"><i data-lucide="umbrella" class="w-5 h-5"></i> Retraite</button>
                </div>
            </div>
            <div id="cause-container" class="overflow-hidden transition-all duration-300">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 mt-4">Cause</h3>
                <div class="flex bg-slate-200 p-1 rounded-xl"><button onclick="setCause('maladie')" id="btn-maladie" class="cause-btn flex-1 py-2 rounded-lg text-sm font-bold transition-all capitalize bg-white shadow text-slate-900">Maladie</button><button onclick="setCause('accident')" id="btn-accident" class="cause-btn flex-1 py-2 rounded-lg text-sm font-bold transition-all capitalize text-slate-500 hover:text-slate-700">Accident</button></div>
            </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="lg:w-2/3 p-6 md:p-12 flex flex-col relative bg-white">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
                <div><h2 class="text-3xl font-extrabold text-slate-900 leading-tight">Projection <span id="scenario-title" class="text-winwin-dark">Invalidité</span></h2><p class="text-slate-500 font-medium flex items-center gap-2"><span id="status-display">Employé</span> • <span id="cause-display">Cause Maladie</span></p></div>
                <div id="alert-badge" class="px-4 py-2 rounded-full font-bold flex items-center gap-2 transition-colors"></div>
            </div>
            <div class="relative flex-grow flex flex-col justify-end min-h-[350px] mb-8">
                <div class="absolute top-0 w-full border-t-2 border-dashed border-slate-300 z-10"><span class="absolute -top-7 right-0 bg-slate-800 text-white text-xs font-bold px-2 py-1 rounded">Objectif: <span id="target-salary">6'500</span> CHF</span></div>
                <div class="flex items-end justify-center gap-2 md:gap-8 w-full z-10 pb-8 border-b border-slate-100">
                    <div class="flex flex-col items-center justify-end h-80 w-full md:w-28 gap-2 group"><div class="text-center h-8 flex items-end justify-center font-bold text-slate-700 text-sm" id="p1-percent"></div><div class="w-full h-64 bg-slate-100 rounded-t-lg relative flex items-end overflow-hidden"><div id="p1-bar" class="bar-transition w-full bg-slate-600 shadow-lg flex items-start justify-center pt-2 border-t border-white/20" style="height: 0%"><i data-lucide="shield-check" class="text-white/40 w-8 h-8 mt-2"></i></div></div><div class="font-bold text-slate-600 text-xs uppercase tracking-wider h-10 flex items-center text-center">1er Pilier</div></div>
                    <div class="text-slate-300 pb-10 font-bold text-xl">+</div>
                    <div class="flex flex-col items-center justify-end h-80 w-full md:w-28 gap-2 group"><div class="text-center h-8 flex items-end justify-center font-bold text-slate-700 text-sm" id="p2-percent"></div><div class="w-full h-64 bg-slate-100 rounded-t-lg relative flex items-end overflow-hidden"><div id="p2-bar" class="bar-transition w-full bg-winwin-dark shadow-lg flex items-start justify-center pt-2 border-t border-white/20" style="height: 0%"><i data-lucide="briefcase" class="text-white/40 w-8 h-8 mt-2"></i></div><div id="p2-warning" class="hidden absolute inset-0 flex items-center justify-center text-red-300 bg-red-50/50"><span class="font-bold text-xs transform -rotate-45 border border-red-300 px-2 py-1 rounded text-red-500 bg-white">NON COUVERT</span></div></div><div class="font-bold text-slate-600 text-xs uppercase tracking-wider h-10 flex items-center text-center" id="p2-label">2e Pilier</div></div>
                    <div class="text-slate-300 pb-10 font-bold text-xl">=</div>
                    <div class="flex flex-col items-center justify-end h-80 w-full md:w-28 gap-2 group"><div class="text-center h-8 flex items-end justify-center font-bold text-red-600 text-xl" id="gap-percent"></div><div class="w-full h-64 bg-slate-50 rounded-t-lg relative flex items-end"><div id="gap-bar" class="bar-transition w-full bg-stripes-red border-2 border-red-500 shadow-xl flex items-center justify-center relative overflow-hidden rounded-t-lg" style="height: 0%"><div id="gap-label" class="hidden bg-white/90 px-2 py-1 rounded text-red-600 font-bold text-xs whitespace-nowrap shadow-sm transform -rotate-3 border border-red-100">LACUNE</div></div></div><div class="font-bold text-red-600 text-xs uppercase tracking-wider h-10 flex items-center text-center">À Combler</div></div>
                </div>
            </div>
            <div id="explanation-box" class="p-6 rounded-2xl border-l-4 mb-6 bg-blue-50 border-winwin-dark transition-colors duration-500">
                <div class="flex gap-4"><div class="mt-1"><i data-lucide="alert-circle" id="explanation-icon" class="text-winwin-dark"></i></div><div><h4 class="font-bold text-lg mb-1 text-slate-800">Analyse de votre situation</h4><p id="explanation-text" class="text-slate-700 leading-relaxed">Chargement...</p></div></div>
            </div>
            <div id="total-loss-container" class="mb-6 p-4 bg-red-50 rounded-xl border border-red-100 flex items-center justify-between hidden">
                <div class="flex items-center gap-3"><div class="bg-red-100 p-2 rounded-lg text-red-600"><i data-lucide="trending-down" class="w-6 h-6"></i></div><div><div class="text-sm text-red-800 font-bold uppercase">Impact cumulé</div><div class="text-xs text-red-600">Jusqu'à 65 ans</div></div></div>
                <div class="text-right"><div class="text-2xl font-black text-red-600"><span id="total-loss-amount">0</span> CHF</div><div class="text-xs text-red-500">de perte potentielle</div></div>
            </div>
            <div class="bg-slate-900 rounded-2xl overflow-hidden shadow-2xl">
                <div class="p-8 pb-4 border-b border-slate-700">
                    <h3 class="text-center text-xl md:text-2xl font-bold text-white mb-6">Quel montant êtes-vous prêt(e) à investir ?</h3>
                    <div class="flex flex-col md:flex-row justify-center items-center gap-6">
                        <div class="bg-slate-800 p-1 rounded-lg flex items-center"><button onclick="setInvestmentFreq('month')" id="freq-month" class="px-6 py-2 rounded-md font-bold text-sm transition-all bg-winwin-dark text-white shadow-lg">Mensuel</button><button onclick="setInvestmentFreq('year')" id="freq-year" class="px-6 py-2 rounded-md font-bold text-sm transition-all text-slate-400 hover:text-white">Annuel</button></div>
                        <div class="flex items-center gap-3"><div class="relative"><input type="number" id="invest-amount" class="bg-slate-800 text-white font-bold text-3xl w-48 px-4 py-2 rounded-xl border border-slate-600 focus:border-winwin-light outline-none text-right transition-colors" value="200"><span class="absolute right-14 top-1/2 -translate-y-1/2 text-slate-500 text-sm hidden">CHF</span></div><span class="text-2xl text-white font-bold">CHF</span></div>
                    </div>
                </div>
                <div class="p-6 md:p-8 flex flex-col md:flex-row justify-between items-center gap-6 bg-slate-900">
                    <div class="text-white text-center md:text-left"><div class="text-slate-400 text-sm font-bold uppercase tracking-wider mb-1">Votre Engagement</div><div class="text-lg">Je souhaite combler ma lacune de <span class="text-yellow-400 font-bold"><span id="gap-amount">0</span> CHF</span></div></div>
                    <button onclick="openModal()" class="bg-yellow-400 hover:bg-yellow-300 text-slate-900 font-bold py-4 px-8 rounded-full shadow-[0_0_20px_rgba(250,204,21,0.4)] transition-all transform hover:scale-105 flex items-center gap-2 text-lg"><i data-lucide="target" class="w-6 h-6"></i>Obtenir mon plan d'action</button>
                </div>
            </div>
            <p class="text-center text-slate-400 text-xs mt-6">*Simulation simplifiée. Plafonds légaux 2025. Ne remplace pas un calcul actuariel précis.</p>
        </div>
    </div>

    <script>
        const MAX_AVS_RENTE = 2520, MAX_LAA_SALARY = 12350, COORDINATION_LPP = 2205, RETIREMENT_AGE = 65;
        const scenarioLabels = { 'invalidite': 'Invalidité', 'deces': 'Décès', 'retraite': 'Retraite' };
        const causeLabels = { 'maladie': 'Maladie', 'accident': 'Accident', 'vie': 'Vie' };
        let state = { salary: 6500, age: 40, status: 'employee', scenario: 'invalidite', cause: 'maladie', investFreq: 'month', investAmount: 200, currentGap: 0, isCouple: false };

        document.getElementById('salaryInput').addEventListener('input', (e) => { state.salary = Number(e.target.value); update(); });
        document.getElementById('salaryRange').addEventListener('input', (e) => { state.salary = Number(e.target.value); document.getElementById('salaryInput').value = state.salary; update(); });
        document.getElementById('ageInput').addEventListener('input', (e) => { updateAge(Number(e.target.value)); });
        document.getElementById('ageRange').addEventListener('input', (e) => { updateAge(Number(e.target.value)); });
        document.getElementById('invest-amount').addEventListener('input', (e) => { state.investAmount = Number(e.target.value); });

        function openModal() { document.getElementById('modal-overlay').classList.add('open'); const dobInput = document.getElementById('input-dob'); if(!dobInput.value) dobInput.value = `${new Date().getFullYear() - state.age}-01-01`; toggleServiceDetails(); }
        function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }
        function toggleMarriageDate() {
            const civil = document.getElementById('input-civil').value;
            const divMarriage = document.getElementById('div-marriage-date');
            (civil === 'Marié(e)' || civil === 'Partenariat') ? divMarriage.classList.remove('hidden') : divMarriage.classList.add('hidden');
        }
        
        function setCoupleMode(isCouple) {
            state.isCouple = isCouple;
            const btnSolo = document.getElementById('btn-solo');
            const btnCouple = document.getElementById('btn-couple');
            const partnerSection = document.getElementById('partner-section');
            const docPartner = document.getElementById('doc-partner');
            const priceTag = document.getElementById('price-tag');
            const labelAVS = document.getElementById('label-avs');
            const label3P = document.getElementById('label-3pilier');

            if (isCouple) {
                btnSolo.className = "px-3 py-1 text-xs rounded font-bold text-slate-500 hover:text-slate-800 transition-all";
                btnCouple.className = "px-3 py-1 text-xs rounded font-bold bg-white shadow text-slate-800 transition-all";
                partnerSection.classList.remove('hidden');
                docPartner.classList.remove('hidden');
                priceTag.innerText = "350.-";
                labelAVS.innerText = "Compte AVS (Vous)";
                label3P.innerText = "Polices 3e pilier (Couple)";
            } else {
                btnSolo.className = "px-3 py-1 text-xs rounded font-bold bg-white shadow text-slate-800 transition-all";
                btnCouple.className = "px-3 py-1 text-xs rounded font-bold text-slate-500 hover:text-slate-800 transition-all";
                partnerSection.classList.add('hidden');
                docPartner.classList.add('hidden');
                priceTag.innerText = "250.-";
                labelAVS.innerText = "Compte Individuel AVS";
                label3P.innerText = "Polices 3e pilier existantes";
            }
            toggleEmployerFields(); // Re-evaluate employer fields
        }

        function toggleServiceDetails() {
            const serviceType = document.querySelector('input[name="serviceType"]:checked').value;
            const submitBtn = document.getElementById('btn-submit-modal');
            const checklist = document.getElementById('expert-checklist');
            const toggleArea = document.getElementById('couple-toggle-area');
            const docEmployee = document.getElementById('doc-employee');
            const docIndependent = document.getElementById('doc-independent');

            if (state.status === 'employee') { docEmployee.classList.remove('hidden'); docIndependent.classList.add('hidden'); }
            else { docEmployee.classList.add('hidden'); docIndependent.classList.remove('hidden'); }
            
            if(serviceType === 'expert') {
                checklist.classList.remove('hidden');
                toggleArea.classList.remove('hidden');
                submitBtn.innerHTML = `<span>Lancer l'audit (Expert)</span><i data-lucide="check-circle" class="w-5 h-5"></i>`;
                submitBtn.classList.remove('bg-yellow-400', 'hover:bg-yellow-300', 'text-slate-900'); submitBtn.classList.add('bg-winwin-dark', 'hover:bg-[#255a80]', 'text-white');
            } else {
                checklist.classList.add('hidden');
                toggleArea.classList.add('hidden');
                submitBtn.innerHTML = `<span>Valider la demande</span><i data-lucide="arrow-right" class="w-5 h-5"></i>`;
                submitBtn.classList.add('bg-yellow-400', 'hover:bg-yellow-300', 'text-slate-900'); submitBtn.classList.remove('bg-winwin-dark', 'hover:bg-[#255a80]', 'text-white');
            }
            toggleEmployerFields();
            lucide.createIcons();
        }

        function toggleEmployerFields() {
            const serviceType = document.querySelector('input[name="serviceType"]:checked').value;
            const isMandate = document.getElementById('check-mandate').checked;
            const p1Fields = document.getElementById('employer-fields-p1');
            const p2Fields = document.getElementById('employer-fields-p2');
            
            // Logic P1: Show if Mandate + Expert + P1 is Employee
            if (serviceType === 'expert' && isMandate && state.status === 'employee') {
                p1Fields.classList.remove('hidden');
            } else {
                p1Fields.classList.add('hidden');
            }

            // Logic P2: Show if Mandate + Expert + Couple + P2 is Employee
            const p2Status = document.getElementById('input-status-p2').value;
            if (serviceType === 'expert' && isMandate && state.isCouple && p2Status === 'Employé') {
                p2Fields.classList.remove('hidden');
            } else {
                p2Fields.classList.add('hidden');
            }
        }

        function updateChildrenFields() {
            const count = parseInt(document.getElementById('input-children-count').value) || 0;
            const container = document.getElementById('children-details-container');
            container.innerHTML = ''; // Clear existing

            if (count > 0) {
                container.innerHTML = `<h5 class="text-xs font-bold text-winwin-dark mt-3 mb-2">Détails Enfants (${count})</h5>`;
                for (let i = 1; i <= count; i++) {
                    const html = `
                    <div class="bg-slate-50 p-2 rounded border border-slate-200 mb-2">
                        <div class="text-[10px] font-bold text-slate-400 mb-1">Enfant ${i}</div>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="text" id="child-fname-${i}" placeholder="Prénom" class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs focus:border-winwin-dark outline-none">
                            <input type="text" id="child-lname-${i}" placeholder="Nom" class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs focus:border-winwin-dark outline-none">
                            <input type="date" id="child-dob-${i}" class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs focus:border-winwin-dark outline-none">
                        </div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                }
            }
        }

        function finalSubmit() {
            // Person 1
            const fname = document.getElementById('input-fname').value || "";
            const lname = document.getElementById('input-lname').value || "";
            const dob = document.getElementById('input-dob').value;
            const profession = document.getElementById('input-profession').value || "Non renseignée";
            const civil = document.getElementById('input-civil').value;
            const childrenCount = document.getElementById('input-children-count').value;
            const smoker = document.querySelector('input[name="smoker"]:checked').value;
            
            // Children Details
            let childrenDetails = [];
            const count = parseInt(childrenCount) || 0;
            for(let i=1; i<=count; i++) {
                const cFname = document.getElementById(`child-fname-${i}`).value || "-";
                const cLname = document.getElementById(`child-lname-${i}`).value || "-";
                const cDob = document.getElementById(`child-dob-${i}`).value || "-";
                childrenDetails.push(`Enfant ${i}: ${cFname} ${cLname} (${cDob})`);
            }

            // Person 2
            let p2 = null;
            if(state.isCouple) {
                const dob2 = document.getElementById('input-dob-p2').value;
                p2 = {
                    fname: document.getElementById('input-fname-p2').value || "",
                    lname: document.getElementById('input-lname-p2').value || "",
                    dob: dob2 ? new Date(dob2).toLocaleDateString('fr-CH') : "Non renseignée",
                    profession: document.getElementById('input-profession-p2').value || "Non renseignée",
                    status: document.getElementById('input-status-p2').value,
                    smoker: document.querySelector('input[name="smoker-p2"]:checked').value
                };
            }

            const serviceType = document.querySelector('input[name="serviceType"]:checked').value;
            
            let marriageDate = (civil === 'Marié(e)' || civil === 'Partenariat') ? (document.getElementById('input-marriage-date').value ? new Date(document.getElementById('input-marriage-date').value).toLocaleDateString('fr-CH') : "Non renseignée") : "Non concerné";
            let dobFormatted = dob ? new Date(dob).toLocaleDateString('fr-CH') : "Non renseignée";

            const isMandate = document.getElementById('check-mandate').checked;
            const has3Pilier = document.getElementById('check-3pilier').checked;
            let coverageDetails = [];
            if(state.status === 'employee') {
                if(document.getElementById('check-contract').checked) coverageDetails.push("Contrat de travail (720j)");
                if(document.getElementById('check-lpp').checked) coverageDetails.push("LPP");
            } else {
                if(document.getElementById('check-apg-maladie').checked) coverageDetails.push("APG Maladie existante");
                if(document.getElementById('check-apg-accident').checked) coverageDetails.push("Assurance Accident existante");
            }

            // Employer P1
            let employerP1 = null;
            if (state.status === 'employee' && serviceType === 'expert' && isMandate) {
                const empName = document.getElementById('input-emp-p1-name').value;
                const empLoc = document.getElementById('input-emp-p1-loc').value;
                const empPhone = document.getElementById('input-emp-p1-phone').value;
                if(empName || empLoc) employerP1 = { name: empName, loc: empLoc, phone: empPhone };
            }

            // Employer P2
            let employerP2 = null;
            if (state.isCouple && p2 && p2.status === 'Employé' && serviceType === 'expert' && isMandate) {
                const empName = document.getElementById('input-emp-p2-name').value;
                const empLoc = document.getElementById('input-emp-p2-loc').value;
                const empPhone = document.getElementById('input-emp-p2-phone').value;
                if(empName || empLoc) employerP2 = { name: empName, loc: empLoc, phone: empPhone };
            }

            const profileData = {
                fname, lname,
                dob: dobFormatted,
                profession: profession,
                civil: civil,
                marriageDate: marriageDate,
                childrenCount: childrenCount,
                childrenDetails: childrenDetails,
                smoker: smoker,
                service: serviceType,
                isMandate: isMandate,
                has3Pilier: has3Pilier,
                coverageDetails: coverageDetails.join(", ") || "Aucune",
                employerP1,
                employerP2,
                isCouple: state.isCouple,
                p2: p2
            };

            copyAndRedirect(profileData);
            closeModal();
        }

        // --- CORE FUNCTIONS ---

        function updateAge(val) {
            val = Math.min(Math.max(val, 18), 64);
            state.age = val; document.getElementById('ageInput').value = val; document.getElementById('ageRange').value = val;
            const yearsLeft = RETIREMENT_AGE - val;
            document.getElementById('years-left').innerText = yearsLeft;
            const pPast = (val / RETIREMENT_AGE) * 100;
            document.getElementById('age-progress-past').style.width = pPast + '%'; document.getElementById('age-progress-future').style.width = (100 - pPast) + '%';
            update();
        }

        function setStatus(s) { state.status = s; updateUI(); update(); }
        function setScenario(s) { state.scenario = s; if(s === 'retraite') state.cause = 'vie'; else if(state.cause === 'vie') state.cause = 'maladie'; updateUI(); update(); }
        function setCause(c) { state.cause = c; updateUI(); update(); }
        
        function setInvestmentFreq(f) { 
            state.investFreq = f; 
            const bm = document.getElementById('freq-month'), by = document.getElementById('freq-year'), inp = document.getElementById('invest-amount');
            if (f === 'month') { bm.className = "px-6 py-2 rounded-md font-bold text-sm transition-all bg-winwin-dark text-white shadow-lg"; by.className = "px-6 py-2 rounded-md font-bold text-sm transition-all text-slate-400 hover:text-white"; if(state.investAmount > 1000) inp.value = Math.round(state.investAmount / 12); } 
            else { bm.className = "px-6 py-2 rounded-md font-bold text-sm transition-all text-slate-400 hover:text-white"; by.className = "px-6 py-2 rounded-md font-bold text-sm transition-all bg-winwin-dark text-white shadow-lg"; if(state.investAmount < 1000) inp.value = state.investAmount * 12; }
            state.investAmount = Number(inp.value);
        }

        function updateUI() {
            const btnEmp = document.getElementById('btn-employee'), btnInd = document.getElementById('btn-independent'), tagInd = document.getElementById('tag-indep');
            if(state.status === 'employee') { btnEmp.className = "status-btn flex items-center justify-between p-4 rounded-xl transition-all border-2 border-winwin-dark bg-[#eef6fa] text-winwin-dark"; btnInd.className = "status-btn flex items-center justify-between p-4 rounded-xl transition-all border-2 border-transparent bg-white text-slate-600 hover:bg-white/50"; tagInd.classList.add('hidden'); } 
            else { btnEmp.className = "status-btn flex items-center justify-between p-4 rounded-xl transition-all border-2 border-transparent bg-white text-slate-600 hover:bg-white/50"; btnInd.className = "status-btn flex items-center justify-between p-4 rounded-xl transition-all border-2 border-indigo-600 bg-indigo-50 text-indigo-900"; tagInd.classList.remove('hidden'); }
            
            ['invalidite', 'deces', 'retraite'].forEach(s => {
                const btn = document.getElementById('btn-'+s); const icon = btn.querySelector('svg');
                if(state.scenario === s) { btn.className = "scenario-btn p-3 rounded-lg text-left font-bold transition-all flex items-center gap-3 bg-slate-800 text-white shadow-lg"; if(icon) { if(s==='invalidite') icon.classList.add('text-orange-400'); if(s==='deces') icon.classList.add('text-red-400'); if(s==='retraite') icon.classList.add('text-green-400'); } } 
                else { btn.className = "scenario-btn p-3 rounded-lg text-left font-bold transition-all flex items-center gap-3 bg-white text-slate-600 hover:bg-white/80"; if(icon) icon.classList.remove('text-orange-400', 'text-red-400', 'text-green-400'); }
            });
            const cc = document.getElementById('cause-container');
            if(state.scenario === 'retraite') { cc.style.height = '0px'; cc.style.opacity = '0'; } else { cc.style.height = 'auto'; cc.style.opacity = '1'; ['maladie', 'accident'].forEach(c => { const btn = document.getElementById('btn-'+c); if(state.cause === c) btn.className = "cause-btn flex-1 py-2 rounded-lg text-sm font-bold transition-all capitalize bg-white shadow text-slate-900"; else btn.className = "cause-btn flex-1 py-2 rounded-lg text-sm font-bold transition-all capitalize text-slate-500 hover:text-slate-700"; }); }
        }

        function update() {
            let p1Amount = 0, p2Amount = 0, text = "", alertLevel = "low"; const salary = state.salary;
            const avsBase = Math.min(salary, MAX_AVS_RENTE * 3);
            if (state.scenario === 'deces') p1Amount = Math.min(salary * 0.6, MAX_AVS_RENTE * 0.8); else { if (salary < 4000) p1Amount = salary * 0.7; else p1Amount = Math.min(salary * 0.8, MAX_AVS_RENTE); }
            if (state.status === 'independent') p2Amount = 0; else { if (state.cause === 'accident' && state.scenario !== 'retraite') { p2Amount = Math.min(salary, MAX_LAA_SALARY) * 0.9; p1Amount = 0; } else { p2Amount = Math.max(0, salary - COORDINATION_LPP) * 0.4; } }
            
            if (state.status === 'independent') {
                if (state.scenario === 'invalidite') { text = state.cause === 'maladie' ? "ALERTE ROUGE. Maladie = AI seule. Chute libre sans privée." : "DANGER. Accident = AI seule sans LAA."; alertLevel = "critical"; }
                else if (state.scenario === 'retraite') { text = "Précarité. AVS seule insuffisante."; alertLevel = "high"; }
                else { text = "Protection quasi nulle."; alertLevel = "critical"; }
            } else {
                if (state.cause === 'accident' && state.scenario !== 'retraite') { text = "Couverture Excellente (LAA)."; alertLevel = "low"; }
                else if (state.scenario === 'invalidite') { text = "Piège 720j. Perte ~40% revenu."; alertLevel = "high"; }
                else if (state.scenario === 'retraite') { text = "Mur de la Retraite. Perte brutale."; alertLevel = "medium"; }
                else { text = "Rentes veuves faibles."; alertLevel = "high"; }
            }

            const p1 = Math.min(100, (p1Amount/salary)*100), p2 = Math.min(100, (p2Amount/salary)*100);
            let gap = Math.max(0, salary - p1Amount - p2Amount), gapP = Math.max(0, 100 - (p1+p2));
            state.currentGap = gap;

            document.getElementById('target-salary').innerText = salary.toLocaleString('fr-CH');
            document.getElementById('gap-amount').innerText = Math.round(gap).toLocaleString('fr-CH');
            document.getElementById('scenario-title').innerText = scenarioLabels[state.scenario];
            document.getElementById('status-display').innerText = state.status === 'employee' ? 'Employé' : 'Indépendant';
            document.getElementById('cause-display').innerText = state.scenario === 'retraite' ? 'Vie' : 'Cause ' + causeLabels[state.cause];
            document.getElementById('explanation-text').innerText = text;

            const badge = document.getElementById('alert-badge');
            if(alertLevel === 'critical') { badge.className = "bg-red-50 border border-red-200 text-red-600 px-4 py-2 rounded-full font-bold flex items-center gap-2 animate-pulse"; badge.innerHTML = `<i data-lucide="alert-triangle" class="w-5 h-5"></i> DANGER`; }
            else if(alertLevel === 'high') { badge.className = "bg-orange-50 border border-orange-200 text-orange-600 px-4 py-2 rounded-full font-bold flex items-center gap-2"; badge.innerHTML = `<i data-lucide="alert-triangle" class="w-5 h-5"></i> Risque Élevé`; }
            else { badge.className = "bg-green-50 border border-green-200 text-green-600 px-4 py-2 rounded-full font-bold flex items-center gap-2"; badge.innerHTML = `<i data-lucide="shield-check" class="w-5 h-5"></i> OK`; }

            document.getElementById('p1-bar').style.height = `${p1}%`; document.getElementById('p1-percent').innerText = p1>0?`${Math.round(p1)}%`:'';
            document.getElementById('p2-bar').style.height = `${p2}%`; document.getElementById('p2-percent').innerText = p2>0?`${Math.round(p2)}%`:'';
            document.getElementById('gap-bar').style.height = `${gapP}%`; document.getElementById('gap-percent').innerText = gapP>1?`-${Math.round(gapP)}%`:'';
            
            const p2W = document.getElementById('p2-warning');
            if(state.status === 'independent') { document.getElementById('p2-label').innerText = "2e Pilier (Aucun)"; document.getElementById('p2-bar').className = "bar-transition w-full bg-slate-200 shadow-lg flex items-start justify-center pt-2 border-t border-white/20"; if(p2===0) p2W.classList.remove('hidden'); else p2W.classList.add('hidden'); }
            else { document.getElementById('p2-label').innerText = "2e Pilier (LPP/LAA)"; document.getElementById('p2-bar').className = "bar-transition w-full bg-winwin-dark shadow-lg flex items-start justify-center pt-2 border-t border-white/20"; p2W.classList.add('hidden'); }
            
            const gapLabel = document.getElementById('gap-label'); if(gapP > 15) gapLabel.classList.remove('hidden'); else gapLabel.classList.add('hidden');

            // Total Loss
            const lossCont = document.getElementById('total-loss-container');
            if(gap > 0) {
                const total = gap * 12 * (RETIREMENT_AGE - state.age);
                document.getElementById('total-loss-amount').innerText = total.toLocaleString('fr-CH', {maximumFractionDigits: 0});
                lossCont.classList.remove('hidden'); lossCont.classList.add('flex');
            } else { lossCont.classList.add('hidden'); lossCont.classList.remove('flex'); }
        }

        function copyAndRedirect(data) {
            const freqLabel = state.investFreq === 'month' ? 'Mensuel' : 'Annuel';
            const statusLabel = state.status === 'employee' ? 'Employé (avec LPP)' : 'Indépendant';
            const smokerLabel = data.smoker === 'oui' ? 'OUI' : 'NON';
            let message = "";

            if (data.service === 'expert') {
                let mandateText = data.isMandate ? "✅ OUI, je donne procuration à WinWin." : "❌ NON, je fournis les documents.";
                let empSectionP1 = data.employerP1 ? `\n--- EMPLOYEUR P1 (Vous) ---\n• Société : ${data.employerP1.name}\n• Lieu : ${data.employerP1.loc}\n• Contact : ${data.employerP1.phone}` : "";
                let empSectionP2 = data.employerP2 ? `\n--- EMPLOYEUR P2 (Conjoint) ---\n• Société : ${data.employerP2.name}\n• Lieu : ${data.employerP2.loc}\n• Contact : ${data.employerP2.phone}` : "";
                
                let partnerSection = "";
                let priceLabel = "250.- (Individuel)";
                
                if (data.isCouple && data.p2) {
                    priceLabel = "350.- (Couple)";
                    partnerSection = `\n--- PROFIL 2 (Conjoint) ---\n• Prénom Nom : ${data.p2.fname} ${data.p2.lname}\n• Date de naissance : ${data.p2.dob}\n• Profession : ${data.p2.profession}\n• Statut : ${data.p2.status}\n• Fumeur : ${data.p2.smoker === 'oui' ? 'OUI' : 'NON'}\n`;
                }

                let childrenSection = "";
                if(data.childrenDetails.length > 0) {
                    childrenSection = `\n--- ENFANTS ---\n` + data.childrenDetails.join("\n") + "\n";
                }

                message = `Bonjour,\n\nJ'ai réalisé une simulation Mapping 360° et je souhaite passer à l'étape supérieure.\n\n🚨 JE CHOISIS L'OPTION : BILAN GLOBAL EXPERT (${priceLabel})\nJe souhaite une analyse de prévoyance personnalisée basée sur mes chiffres réels.\n\n--- MON DOSSIER ---\n• Option Procuration : ${mandateText}\n• Contrats 3e pilier existants : ${data.has3Pilier ? "Oui" : "Non"}\n• Situation Couverture : ${data.coverageDetails}\n${empSectionP1}${empSectionP2}\n--- PROFIL 1 ---\n• Prénom Nom : ${data.fname} ${data.lname}\n• Statut : ${statusLabel}\n• Âge actuel : ${state.age} ans\n• Date de naissance : ${data.dob}\n• Profession : ${data.profession}\n• État Civil : ${data.civil} (Date : ${data.marriageDate})\n• Enfants à charge : ${data.childrenCount}\n• Fumeur : ${smokerLabel}\n• Revenu approx : ${state.salary.toLocaleString('fr-CH')} CHF\n${childrenSection}${partnerSection}\nMerci de me contacter pour lancer la procédure.`;
            } else {
                let childrenSection = "";
                if(data.childrenDetails.length > 0) {
                    childrenSection = `\n--- ENFANTS ---\n` + data.childrenDetails.join("\n") + "\n";
                }
                
                message = `Bonjour,\n\nVoici les résultats de ma simulation Mapping 360° sur votre site. Je souhaite une offre simple pour combler ma lacune.\n\n--- PROFIL ---\n• Prénom Nom : ${data.fname} ${data.lname}\n• Statut : ${statusLabel}\n• Âge actuel : ${state.age} ans\n• Date de naissance : ${data.dob}\n• Profession : ${data.profession}\n• Situation : ${data.civil}\n• Enfants : ${data.childrenCount}\n• Fumeur : ${smokerLabel}\n• Revenu : ${state.salary.toLocaleString('fr-CH')} CHF\n${childrenSection}\n--- MA SITUATION PROJETÉE ---\n• Scénario : ${scenarioLabels[state.scenario]} (Cause: ${causeLabels[state.cause]})\n• Lacune identifiée : ${Math.round(state.currentGap).toLocaleString('fr-CH')} CHF / mois\n\n--- MON ENGAGEMENT ---\n💰 Mon budget d'investissement : ${state.investAmount} CHF / ${freqLabel}\n\nMerci de me recontacter pour une proposition.`;
            }

            const textArea = document.createElement("textarea"); textArea.value = message; document.body.appendChild(textArea); textArea.select();
            try { document.execCommand('copy'); const toast = document.getElementById("toast"); toast.className = "flex items-center gap-3 show"; setTimeout(()=>toast.className = toast.className.replace("show", ""), 5000); } catch (err) { alert("Erreur copie."); }
            document.body.removeChild(textArea);
            setTimeout(() => { window.open("https://www.winwin.swiss/contact", "_blank"); }, 1500);
        }

        // Init
        lucide.createIcons(); updateAge(40); updateUI();
    </script>
</body>
</html>